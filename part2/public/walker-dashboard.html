<!-- ADD: Logout button in header section (replace the <h1> tag) -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="text-success">Walker Dashboard</h1>
  <div>
    <span class="me-3">Welcome, <strong>{{ currentUser.username }}</strong>!</span>
    <button @click="logout" class="btn btn-outline-danger">
      <i class="bi bi-box-arrow-right"></i> Logout
    </button>
  </div>
</div>

<!-- MODIFY: Update the setup() function to include logout functionality -->
<script>
const { createApp, ref, onMounted } = Vue;

createApp({
  setup() {
    // ADD: Current user state for displaying username and role checking
    const currentUser = ref({ username: 'Loading...' });

    const walks = ref([]);
    const message = ref('');
    const error = ref('');
    const user = 3; // Default walker ID - could be replaced with session user ID

    // ADD: Function to check if user is logged in and is a walker
    async function checkAuth() {
      try {
        const response = await fetch('/api/users/me');
        if (response.ok) {
          const userData = await response.json();
          currentUser.value = userData;

          // Redirect if not a walker
          if (userData.role !== 'walker') {
            window.location.href = '/owner-dashboard.html';
          }
        } else {
          // Not logged in, redirect to login
          window.location.href = '/';
        }
      } catch (err) {
        console.error('Auth check failed:', err);
        window.location.href = '/';
      }
    }

    // ADD: Logout function
    async function logout() {
      try {
        const response = await fetch('/api/users/logout', {
          method: 'POST',
          credentials: 'same-origin' // Ensure cookies are sent
        });

        if (response.ok) {
          // Clear any local storage if used
          localStorage.clear();
          sessionStorage.clear();

          // Redirect to login page
          window.location.href = '/';
        } else {
          error.value = 'Logout failed';
        }
      } catch (err) {
        console.error('Logout error:', err);
        error.value = 'Logout failed';
      }
    }

    async function loadWalkRequests() {
      try {
        const res = await fetch('/api/walks');
        if (!res.ok) throw new Error('Failed to load walk requests');
        walks.value = await res.json();
      } catch (err) {
        error.value = err.message;
      }
    }

    async function applyToWalk(requestId) {
      try {
        // Use actual user ID from session instead of hardcoded value
        const walkerId = currentUser.value.user_id || user;

        const res = await fetch(`/api/walks/${requestId}/apply`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ walker_id: walkerId })
        });
        const result = await res.json();

        if (!res.ok) throw new Error(result.error || 'Application failed');
        message.value = result.message;
        error.value = '';
        await loadWalkRequests();
      } catch (err) {
        error.value = err.message;
        message.value = '';
      }
    }

    onMounted(() => {
      checkAuth(); // ADD: Check authentication on page load
      loadWalkRequests();
    });

    return {
      currentUser, // ADD: Expose current user for template
      walks,
      message,
      error,
      applyToWalk,
      logout // ADD: Expose logout function
    };
  }
}).mount('#app');
</script>